<html>

<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
    integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
    integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
    crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx"
    crossorigin="anonymous"></script>
  <link rel="stylesheet" href="data/master.css">

  <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script type="text/javascript" src="https://mottie.github.io/tablesorter/dist/js/jquery.tablesorter.min.js"></script>

  <script>
    $(function () {
      $("#tablesorter").tablesorter({ sortList: [[0, 0], [0, 0]] });
    });
  </script>

  <link rel="icon" href="data/img/WhenNet.png">
  <title>When.net (Testing)</title>
</head>

<body class="rainbow">
  <div class="jumbotron">
    <h1 class="display-4">Hello, world!</h1>
    <p class="lead">Welcome testers.</p>
    <hr class="my-4">
    <p>Please report any problems or suggestions to the link below.</p>
    <a class="btn btn-primary btn-lg"
      href="https://docs.google.com/forms/d/e/1FAIpQLSepdjOOBBJpFxnH3nsedO8GFMJ1rLCxbUSbAFw8OMpkW83Uog/viewform?usp=pp_url"
      role="button">Report</a>
  </div>
  <div class="sticky-top" id="bar">
    <h1 class="title" id='title'>
      When.net
    </h1>
    <p id="tips">
      Put tips here.
    </p>
    <div id="notif" class="notif"></div>
  </div>
  <div class="inner">
    <div class="tap">
      <p><strong id="username">Loading...</strong>, you have...</p>
      <h2 class="display-1" id="taps">Loading...</h2>
      <p>with a <abbr title="Number of taps per press of space">tap rate</abbr> of...</p>
      <h2 class="display-1" id="rate">Loading...</h2>
      <p>you can upgrade you <abbr title="The number to the left of the x">constant</abbr> at...</p>
      <h2 class="display-1" id="constup">Loading...</h2>
      <p>you can upgrade you <abbr title="The number to the right of the x">mulitplier</abbr> at...</p>
      <h2 class="display-1" id="multiup">Loading...</h2>
      <br>
      <br>
      <p>Press and hold <kbd>Space</kbd> to get taps</p>
      <p>Press <kbd>S</kbd> to save</p>
      <p>Press or hold <kbd>C</kbd> to upgrade the constant</p>
      <p>Press or hold <kbd>M</kbd> to upgrade the multiplier</p>
    </div>
  </div>
  <table class="table table-hover" id="tablesorter">
    <thead>
      <tr>
        <th scope="col">Name</th>
        <th scope="col">Taps</th>
      </tr>
    </thead>
    <tbody id='leaderboard'>
    </tbody>
  </table>
  <!-- The core Firebase JS SDK is always required and must be listed first -->
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-app.js"></script>

  <!-- TODO: Add SDKs for Firebase products that you want to use
        https://firebase.google.com/docs/web/setup#available-libraries -->
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/7.24.0/firebase-firestore.js"></script>

  <script>
    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    var firebaseConfig = {
      apiKey: "AIzaSyBgKnmWvumcDMHCejaefJOI_Ugy8UavWfE",
      authDomain: "whennet.firebaseapp.com",
      databaseURL: "https://whennet.firebaseio.com",
      projectId: "whennet",
      storageBucket: "whennet.appspot.com",
      messagingSenderId: "264909343107",
      appId: "1:264909343107:web:226446c52a61d15e020eb6",
      measurementId: "G-5EP63WZF3H"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    var db = firebase.firestore();

    var email = window.localStorage.getItem("email");
    var userRef = db.collection('users').doc(email)

    var taps
    var constant
    var multiplier
    var constanttier
    var multipliertier
    var constcost
    var multicost

    userRef.get().then(function (doc) {
      if (doc.exists) { //if the user has account load values into localstorage
        var data = doc.data()
        window.localStorage.setItem('taps', data['taps'])
        window.localStorage.setItem('constant', data['constant'])
        window.localStorage.setItem('multiplier', data['multiplier'])
        window.localStorage.setItem('multipliertier', data['multipliertier'])
        window.localStorage.setItem('constanttier', data['constanttier'])
        window.localStorage.setItem('name', data['name'])
      };
    }).then(function () {
      taps = parseInt(window.localStorage.getItem('taps'));
      constant = parseInt(window.localStorage.getItem('constant'));
      multiplier = parseInt(window.localStorage.getItem('multiplier'));
      constanttier = parseInt(window.localStorage.getItem('constanttier'));
      multipliertier = parseInt(window.localStorage.getItem('multipliertier'));
      constcost = 1 * Math.pow(constanttier, 2);
      multicost = 2 * Math.pow(multipliertier, 3);

      db.collection("users").get().then(function (querySnapshot) {
        querySnapshot.forEach(function (doc) {
          // doc.data() is never undefined for query doc snapshots
          var leaderboard = document.getElementById('leaderboard');
          var row = document.createElement('tr');
          var th = document.createElement('th');
          var td = document.createElement('td');

          th.setAttribute('scope', 'row');
          th.innerHTML = doc.data()['name'];

          td.innerHTML = doc.data()['taps'];
          row.appendChild(th);
          row.appendChild(td);
          leaderboard.appendChild(row);
        });
      }).then(function () {
        $(function () {
          $("#tablesorter").tablesorter({ sortList: [[0, 0], [1, 1]] });
        });
        Update();
      });
    });

    var tipslist = [
      'cool beans',
      'Just hold space!',
      'git gud',
      'Buy some stuff',
      'Every 60 seconds in Africa, a minute passes',
      'Smack it like you mean it!'
    ]

    document.getElementById('username').innerHTML = window.localStorage.getItem('name');

    document.getElementById("tips").innerHTML = tipslist[Math.floor(Math.random() * tipslist.length)];

    window.addEventListener("keydown", function (event) {
      if (event.defaultPrevented) {
        return; // Do nothing if the event was already processed
      }

      switch (event.key) {
        case " ":
          Tap();
          break;
        case "s":
          Save();
          break;
        case "c":
          ConstantUp();
          break;
        case "m":
          MultiplierUp();
          break;
        default:
          return; // Quit when this doesn't handle the key event.
      }

      // Cancel the default action to avoid it being handled twice
      event.preventDefault();
    }, true);

    function Tap() {
      taps += constant * multiplier;
      Update();
    };

    function Update() {
      document.getElementById('taps').innerHTML = taps;
      document.getElementById('rate').innerHTML = constant + " x " + multiplier;
      document.getElementById('constup').innerHTML = constcost;
      document.getElementById('multiup').innerHTML = multicost;
    };

    function ConstantUp() {
      if (taps >= constcost) {
        constanttier += 1;
        constant += 1;
        taps -= constcost;
        constcost = Math.pow(2, constanttier);
      };
      Update();
    };

    function MultiplierUp() {
      if (taps >= multicost) {
        multipliertier += 1;
        multiplier += 1;
        taps -= multicost;
        multicost = 2 * Math.pow(3, multipliertier);
      };
      Update();
    };

    function Save() {
      return userRef.update({
        taps: taps,
        constant: constant,
        multiplier: multiplier,
        constanttier: constanttier,
        multipliertier: multipliertier
      }).then(function () {
        PopupSuccess('Saved successfully!', 'success')
      })
    };

    function PopupSuccess(message, type) {
      var bar = document.getElementById('notif');
      var alert = document.createElement('div');
      var close = document.createElement('button');
      var x = document.createElement('span');
      alert.setAttribute('class', 'alert alert-' + type + ' alert-dismissible fade show');
      alert.setAttribute('role', 'alert');
      alert.innerHTML = message;
      close.setAttribute('type', 'button');
      close.setAttribute('class', 'close');
      close.setAttribute('data-dismiss', 'alert');
      close.setAttribute('aria-label', 'Close');
      x.setAttribute('aria-hidden', 'true');
      x.innerHTML = '&times;';
      close.appendChild(x);
      alert.appendChild(close);
      bar.appendChild(alert)
    };
  </script>
</body>

</html>